name: Capacity Benchmark

on:
  workflow_dispatch:   # manual trigger
  schedule:
    - cron: "0 2 * * SUN"   # weekly, if you want to re‑measure after upgrades

jobs:
  bench:
    runs-on: ubuntu‑latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Docker & Python deps
        run: |
          sudo apt-get update && sudo apt-get install -y docker.io
          python -m venv .venv && source .venv/bin/activate && pip install psutil

      - name: Pull latest trader image
        run: docker pull citadel/trader:latest

      - name: Run benchmark
        env:
          BENCH_RUN_SECONDS: 30
          BENCH_SAMPLES: 5
        run: |
          source .venv/bin/activate
          python scripts/capacity_bench.py -c 1 2 4 8 16 > bench_results.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bench-results
          path: bench_results.json
