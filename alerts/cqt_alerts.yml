groups:
  - name: citadel-quantum-trader
    rules:

    # 1ï¸âƒ£ Drawâ€‘down > 5â€¯% (critical â€“ killâ€‘switch will fire)
    - alert: DrawdownCritical
      expr: drawdown_pct > 0.05
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Drawâ€‘down > 5â€¯% on bucket {{ $labels.bucket_id }}"
        description: |
          Current drawâ€‘down: {{ printf "%.2f" $value }}%
          The killâ€‘switch will pause new entries at 15â€¯% drawâ€‘down.
          Investigate immediately.

    # 2ï¸âƒ£ Latency > 150â€¯ms (warning)
    - alert: LatencySpike
      expr: histogram_quantile(0.95, rate(order_latency_seconds_bucket[5m])) > 0.15
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Latency > 150â€¯ms (95th percentile)"
        description: |
          Average 95thâ€‘percentile latency over the last 5â€¯min: {{ printf "%.3f" $value }}â€¯s.
          May indicate network congestion or broker overload.

    # 3ï¸âƒ£ Orderâ€‘rejection surge (>2â€¯% of orders)
    - alert: OrderRejectionSurge
      expr: (increase(order_reject_total[5m]) / increase(order_total[5m])) > 0.02
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "Order rejection rate > 2â€¯%"
        description: |
          Rejection rate: {{ printf "%.2f" $value }}%
          Possible causes: insufficient margin, market closed, bad price.

    # 4ï¸âƒ£ Global riskâ€‘budget approaching limit
    - alert: GlobalRiskHigh
      expr: global_risk_percentage > 0.04   # 80â€¯% of the 5â€¯% limit
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "Global risk budget > 80â€¯% of limit"
        description: |
          Current utilization: {{ printf "%.2f" $value }}%
          The controller will start throttling risk fractions.

groups:
  - name: critical-alerts
    interval: 1m
    rules:

    # -------------------------------------------------
    # 1ï¸âƒ£ Latencyâ€‘spike â€“ avg latency > 0.25â€¯s over 1â€¯min
    # -------------------------------------------------
    - alert: HighOrderLatency
      expr: avg_over_time(rate(order_latency_seconds_sum[1m]) / rate(order_latency_seconds_count[1m])[1m]) > 0.25
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "âš¡ï¸ Order latency > 250â€¯ms (average over 1â€¯min)"
        description: |
          The bot is experiencing high roundâ€‘trip latency.
          Current avg latency: {{ $value | printf "%.3f" }}â€¯s.
          Check network path to the MT5 broker, VPN health, or broker API throttling.

    # -------------------------------------------------
    # 2ï¸âƒ£ Orderâ€‘rejectionâ€‘burst â€“ >â€¯2â€¯% rejections over 5â€¯min
    # -------------------------------------------------
    - alert: OrderRejectionBurst
      expr: (rate(order_reject_total[5m]) / rate(order_total[5m])) > 0.02
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "ðŸš« Orderâ€‘rejection rate > 2â€¯% (5â€‘min window)"
        description: |
          The bot is being rejected by the broker too often.
          Rejection rate: {{ $value | printf \"%.2%\" }}.
          Investigate broker limits, depth checks, or slippage guards.

          groups:
  - name: critical-alerts
    rules:
      - alert: GlobalRiskExceeded
        expr: global_risk_percentage > 4.5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Global risk budget > 4.5â€¯%"
          description: "Aggregated risk exposure is approaching the 5â€¯% cap. The controller will autoâ€‘scale down soon."
          runbook: "https://github.com/yourorg/citadel-qt/blob/main/docs/runbook.md#global-risk-budget"

      - alert: EdgeDecayTriggered
        expr: increase(edge_decay_events_total[5m]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Edgeâ€‘decay detector fired"
          description: "Rolling winâ€‘rate fell below the safety floor; risk fractions have been halved for affected buckets."
          runbook: "https://github.com/yourorg/citadel-qt/blob/main/docs/runbook.md#edge-decay"

          groups:
  - name: streak-alerts
    interval: 1m
    rules:
      - alert: LongLossStreak
        expr: max(bucket_streak_losses) by (bucket_id) > 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Bucket {{ $labels.bucket_id }} has a {{ $value }}â€‘trade loss streak"
          description: "The bot has lost {{ $value }} trades in a row on bucket {{ $labels.bucket_id }}. Consider pausing or investigating the market regime."


groups:
  - name: shock-detector-alerts
    interval: 1m
    rules:
      - alert: HighNewsSentimentBlocking
        expr: sum(rate(trade_blocked_total{reason="news_sentiment"}[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Newsâ€‘sentiment blocker > 2 trades/5â€¯min"
          description: "The sentiment guard is blocking trades â€“ check the newsâ€‘sentiment pipeline."

      - alert: VolatilitySpikeBlocking
        expr: sum(rate(trade_blocked_total{reason="vol_spike"}[5m])) > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Volatilityâ€‘spike blocker active"
          description: "ATR exceeded the configured multiplier â€“ trades are being blocked."

      - alert: MacroEventBlocking
        expr: sum(rate(trade_blocked_total{reason="macro_event"}[5m])) > 0
        for: 1m
        labels:
          severity: info
        annotations:
          summary: "Macroâ€‘event window active"
          description: "A highâ€‘impact macro event is ongoing; trading is paused."

groups:
  - name: predictive-guard-alerts
    rules:
      - alert: HighLatencyGuard
        expr: guard_latency_seconds > 0.15
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Latency guard exceeded 150â€¯ms"
          description: "The preâ€‘trade latency measurement is >150â€¯ms for >1â€¯min."

      - alert: SpreadTooWide
        expr: guard_spread_pips > 0.5
        for: 30s
        labels:
          severity:

          - alert: FeatureDriftModerate
  expr: max by (feature) (feature_psi_*) > 0.1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Feature {{ $labels.feature }} shows moderate PSI drift"
    description: "PSI = {{ $value }} (> 0.1). Consider retraining or pausing the bot."

- alert: FeatureDriftSevere
  expr: max by (feature) (feature_psi_*) > 0.25
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "Feature {{ $labels.feature }} shows severe PSI drift"
    description: "PSI = {{ $value }} (> 0.25). Edgeâ€‘decay detector will tighten thresholds automatically."


groups:
- name: citadel.liquidity
  rules:
  - alert: LowMarketDepth
    expr: bucket_market_depth < 5000   # adjust perâ€‘symbol threshold
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Insufficient depth on bucket {{ $labels.bucket_id }}"
      description: "Total depth < 5â€¯k contracts â€“ trades may slip."

  - alert: ExtremeLiquidityImbalance
    expr: abs(bucket_liquidity_imbalance_ratio) > 0.85
    for: 30s
    labels:
      severity: info
    annotations:
      summary: "Very high LIR ({{ $value }}) on bucket {{ $labels.bucket_id }}"
      description: "Market is heavily oneâ€‘sided; consider tightening riskâ€‘fraction."
groups:
- name: correlation.rules
  rules:
  - alert: HighCorrelationRegime
    expr: cqt_average_correlation > 0.65
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Average 30â€‘day correlation > 0.65"
      description: "Risk caps have been automatically tightened. Review the riskâ€‘fraction schedule if needed."

groups:
  - name: latency-alerts
    rules:
      - alert: HighLatencyDetected
        expr: avg_over_time(order_latency_seconds[30s]) > 0.2   # 200â€¯ms
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Order latency > 200â€¯ms for 30â€¯s"
          description: "Latency spike detected â€“ killâ€‘switch will be activated."

groups:
- name: citadel_alerts
  rules:
  - alert: LatencySpike
    expr: histogram_quantile(0.95, sum(rate(order_latency_seconds_bucket[5m])) > 0.15
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "95thâ€‘percentile latency > 150â€¯ms"
      description: "Investigate depth guard, network, or broker API."

  - alert: HighRejectRate
    expr: sum(rate(order_failure_total[5m])) / sum(rate(order_total[5m])) > 0.02
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Order rejection rate > 2â€¯%"
      description: "Check broker limits, depth guard, or newsâ€‘sentiment filter."

  - alert: KillSwitchActivated
    expr: kill_switch_active == 1
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: "Killâ€‘switch engaged!"
      description: "All new entries are paused. Manual review required."


groups:
- name: citadel.liquidity
  rules:
  - alert: LowMarketDepth
    expr: bucket_market_depth < 5000   # adjust perâ€‘symbol threshold
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Insufficient depth on bucket {{ $labels.bucket_id }}"
      description: "Total depth < 5â€¯k contracts â€“ trades may slip."

  - alert: ExtremeLiquidityImbalance
    expr: abs(bucket_liquidity_imbalance_ratio) > 0.85
    for: 30s
    labels:
      severity: info
    annotations:
      summary: "Very high LIR ({{ $value }}) on bucket {{ $labels.bucket_id }}"
      description: "Market is heavily oneâ€‘sided; consider tightening riskâ€‘fraction."

      groups:
  - name: ledger.rules
    rules:
      - alert: LedgerSnapshotFailed
        expr: ledger_snapshot_success == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Hourly ledger snapshot failed"
          description: |
            The Merkleâ€‘root + signature could not be uploaded to S3 for the last hour.
            Check the `ledger-snapshot-exporter` container logs and the IAM permissions
            for the KMS key and S3 bucket.

